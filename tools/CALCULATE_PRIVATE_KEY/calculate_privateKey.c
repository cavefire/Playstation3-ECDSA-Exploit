#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>
#include <stdbool.h>
#define SIGNATURE_R_SIZE 0x14
#define SIGNATURE_S_SIZE 0x14

typedef unsigned char u8;

typedef struct
{
    unsigned long long int hash;
    unsigned long long int r;
    unsigned long long int s;
} Signature;

Signature signature_1;
Signature signature_2;

int main()
{
    const char *scetoolPath = "./scetool";

    // Argumente für scetool
    const char *scetoolArgs_1[] = {scetoolPath, "-d", "EBOOT_nascar.BIN", "EBOOT_nascar.ELF", NULL};
    const char *scetoolArgs_2[] = {scetoolPath, "-d", "EBOOT_borderlands.BIN", "EBOOT_borderlands.ELF", NULL};

    // Neuer Prozess erstellen
    pid_t pid1 = fork();
    if (pid1 == -1)
    {
        perror("Fehler beim Erstellen des Kindprozesses");
        return 1;
    }

    if (pid1 == 0)
    {
        // scetool aufrufen
        execvp(scetoolPath, (char *const *)scetoolArgs_1);

        // Falls execvp fehlschlägt, wird diese Zeile erreicht
        perror("Fehler beim Ausführen von scetool im Kindprozess");

        execvp(scetoolPath, (char *const *)scetoolArgs_2);

        // Falls execvp fehlschlägt, wird diese Zeile erreicht
        perror("Fehler beim Ausführen von scetool im Kindprozess");

        exit(1);
    }
    else
    {
        // Neuen Prozess erstellen (zweiter Kindprozess)
        pid_t pid2 = fork();

        if (pid2 == -1)
        {
            perror("Fehler beim Erstellen des zweiten Kindprozesses");
            return 1;
        }

        if (pid2 == 0)
        {
            // Zweiter Kindprozess

            // scetool mit den zweiten Argumenten aufrufen
            execvp(scetoolPath, (char *const *)scetoolArgs_2);

            // Falls execvp fehlschlägt, wird diese Zeile erreicht
            perror("Fehler beim Ausführen von scetool im zweiten Kindprozess");
            exit(1);
        }
        int status1, status2;
        waitpid(pid1, &status1, 0);
        waitpid(pid2, &status2, 0);

        // Überprüfen, ob die Kindprozesse erfolgreich beendet wurden
        if (WIFEXITED(status1) && WEXITSTATUS(status1) == 0 &&
            WIFEXITED(status2) && WEXITSTATUS(status2) == 0)
        {
            printf("\033[2J");
            printf("\033[0;0H");
            fflush(stdout);
            printf("scetool wurde erfolgreich ausgeführt\n\n");

            // Textdatei öffnen
            FILE *file_1 = fopen("ergebnisse.txt", "r");
            if (file_1 == NULL)
            {
                perror("Fehler beim Öffnen der Textdatei");
                return 1;
            }

            if (fscanf(file_1, "Hash: %llx", &signature_1.hash) != 1)
            {
                perror("Fehler beim Lesen des Hash-Werts");
                return 1;
            }
            if (fscanf(file_1, "R: %llx", &signature_1.r) != 1)
            {
                perror("Fehler beim Lesen des R-Werts");
                return 1;
            }
            if (fscanf(file_1, "S: %llx", &signature_1.s) != 1)
            {
                perror("Fehler beim Lesen des S-Werts");
                return 1;
            }

            // Datei schließen
            fclose(file_1);

            // Textdatei öffnen
            FILE *file_2 = fopen("ergebnisse_1.txt", "r");
            if (file_2 == NULL)
            {
                perror("Fehler beim Öffnen der Textdatei");
                return 1;
            }

            // Hier soll die Überschrift aus der Datei gelesen werden und in der Konsole ausgegeben werden

            if (fscanf(file_2, "Hash: %llx\n", &signature_2.hash) != 1)
            {
                perror("Fehler beim Lesen des Hash-Werts");
                return 1;
            }
            if (fscanf(file_2, "R: %llx\n", &signature_2.r) != 1)
            {
                perror("Fehler beim Lesen des R-Werts");
                return 1;
            }
            if (fscanf(file_2, "S: %llx\n", &signature_2.s) != 1)
            {
                perror("Fehler beim Lesen des S-Werts");
                return 1;
            }

            // Datei schließen
            fclose(file_2);

            // Ausgabe der Werte
            /*printf("Erster Aufruf:\n");
            printf("Hash: %llu\n", signature_1.hash);
            printf("R: %llu\n", signature_1.r);
            printf("S: %llu\n", signature_1.s);

            printf("\nZweiter Aufruf:\n");
            printf("Hash: %llu\n", signature_2.hash);
            printf("R: %llu\n", signature_2.r);
            printf("S: %llu\n", signature_2.s);*/
        }
        else
        {
            printf("Fehler beim Ausführen von scetool\n");
        }
    }

    return 0;
}
